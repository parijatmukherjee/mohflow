<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mohnitor - Real-time Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.4;
        }

        .header {
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-group label {
            font-size: 12px;
            color: #b0b0b0;
        }

        input, select, button {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #606060;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #505050;
        }

        button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #b0b0b0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff5722;
        }

        .status-dot.connected {
            background: #4CAF50;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 61px);
        }

        .sidebar {
            width: 300px;
            background: #252525;
            border-right: 1px solid #404040;
            padding: 16px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #4CAF50;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .filter-section {
            margin-bottom: 24px;
        }

        .services-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .service-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .service-item:hover {
            background: #2d2d2d;
        }

        .service-item.active {
            background: #4CAF50;
            color: white;
        }

        .service-checkbox {
            width: 16px;
            height: 16px;
        }

        .log-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #b0b0b0;
        }

        .log-stats {
            display: flex;
            gap: 16px;
        }

        .log-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .log-entry {
            display: flex;
            padding: 4px 16px;
            border-bottom: 1px solid #2d2d2d;
            white-space: nowrap;
        }

        .log-entry:hover {
            background: #2a2a2a;
        }

        .log-entry.selected {
            background: #4CAF50;
            color: white;
        }

        .log-timestamp {
            color: #8bc34a;
            width: 200px;
            flex-shrink: 0;
        }

        .log-level {
            width: 80px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .log-level.DEBUG { color: #9e9e9e; }
        .log-level.INFO { color: #2196f3; }
        .log-level.WARN { color: #ff9800; }
        .log-level.ERROR { color: #f44336; }
        .log-level.CRITICAL { color: #e91e63; }

        .log-service {
            color: #9c27b0;
            width: 120px;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-message {
            flex: 1;
            color: #e0e0e0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-details {
            width: 300px;
            background: #252525;
            border-left: 1px solid #404040;
            padding: 16px;
            overflow-y: auto;
            display: none;
        }

        .log-details.visible {
            display: block;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-title {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .detail-content {
            color: #b0b0b0;
            font-size: 11px;
            background: #1a1a1a;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .json-viewer {
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #d32f2f;
            color: white;
            padding: 12px 16px;
            margin: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            ðŸ“Š Mohnitor
        </div>
        <div class="controls">
            <div class="control-group">
                <label>Search:</label>
                <input type="text" id="searchInput" placeholder="Filter logs..." />
            </div>
            <div class="control-group">
                <label>Level:</label>
                <select id="levelFilter">
                    <option value="">All</option>
                    <option value="DEBUG">Debug</option>
                    <option value="INFO">Info</option>
                    <option value="WARN">Warn</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <button id="clearBtn">Clear</button>
            <button id="pauseBtn">Pause</button>
            <button id="exportBtn">Export</button>
        </div>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="filter-section">
                <h3>Services</h3>
                <div class="services-list" id="servicesList">
                    <div class="loading">Loading services...</div>
                </div>
            </div>

            <div class="filter-section">
                <h3>Quick Filters</h3>
                <div class="control-group">
                    <input type="checkbox" id="autoScroll" checked>
                    <label for="autoScroll">Auto-scroll</label>
                </div>
                <div class="control-group">
                    <input type="checkbox" id="showTrace">
                    <label for="showTrace">Show trace IDs</label>
                </div>
            </div>
        </div>

        <div class="log-container">
            <div class="log-header">
                <div class="log-stats">
                    <span>Total: <span id="totalLogs">0</span></span>
                    <span>Filtered: <span id="filteredLogs">0</span></span>
                    <span>Rate: <span id="logRate">0</span>/s</span>
                </div>
                <div>
                    <button id="detailsToggle">Show Details</button>
                </div>
            </div>
            <div class="log-viewer" id="logViewer">
                <div class="loading">Connecting to Mohnitor hub...</div>
            </div>
        </div>

        <div class="log-details" id="logDetails">
            <div class="detail-section">
                <div class="detail-title">Raw Log Event</div>
                <div class="detail-content">
                    <div class="json-viewer" id="rawLogJson">Select a log entry to view details</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MohnitorUI {
            constructor() {
                this.logs = [];
                this.filteredLogs = [];
                this.selectedLog = null;
                this.isPaused = false;
                this.autoScroll = true;
                this.services = new Set();
                this.selectedServices = new Set();
                this.websocket = null;
                this.logRate = 0;
                this.lastLogCount = 0;
                this.rateInterval = null;

                this.initializeUI();
                this.connectWebSocket();
                this.startLogRateCalculation();
            }

            initializeUI() {
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterLogs();
                });

                // Level filter
                document.getElementById('levelFilter').addEventListener('change', (e) => {
                    this.filterLogs();
                });

                // Control buttons
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearLogs();
                });

                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportLogs();
                });

                document.getElementById('detailsToggle').addEventListener('click', () => {
                    this.toggleDetails();
                });

                // Auto-scroll checkbox
                document.getElementById('autoScroll').addEventListener('change', (e) => {
                    this.autoScroll = e.target.checked;
                });

                // Show trace checkbox
                document.getElementById('showTrace').addEventListener('change', (e) => {
                    this.renderLogs();
                });

                // Log viewer click handler
                document.getElementById('logViewer').addEventListener('click', (e) => {
                    const logEntry = e.target.closest('.log-entry');
                    if (logEntry) {
                        this.selectLog(parseInt(logEntry.dataset.index));
                    }
                });
            }

            connectWebSocket() {
                const wsUrl = `ws://${window.location.host}/ws?type=ui`;

                try {
                    this.websocket = new WebSocket(wsUrl);

                    this.websocket.onopen = () => {
                        this.updateStatus(true, 'Connected');
                        this.clearLoadingMessage();
                    };

                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    this.websocket.onclose = () => {
                        this.updateStatus(false, 'Disconnected');
                        this.showError('Connection lost. Attempting to reconnect...');
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };

                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus(false, 'Connection Error');
                    };

                } catch (error) {
                    console.error('Error connecting WebSocket:', error);
                    this.updateStatus(false, 'Connection Failed');
                    this.showFallbackMessage();
                }
            }

            handleWebSocketMessage(data) {
                if (data.type === 'log_event' && data.payload) {
                    this.addLogEvent(data.payload);
                } else if (data.type === 'system_stats' && data.payload) {
                    this.updateSystemStats(data.payload);
                } else if (data.type === 'heartbeat') {
                    // Keep connection alive
                }
            }

            addLogEvent(logEvent) {
                if (this.isPaused) return;

                this.logs.push(logEvent);
                this.services.add(logEvent.service);

                // Keep only last 10000 logs for performance
                if (this.logs.length > 10000) {
                    this.logs.shift();
                }

                this.updateServicesFilter();
                this.filterLogs();
            }

            filterLogs() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const levelFilter = document.getElementById('levelFilter').value;

                this.filteredLogs = this.logs.filter(log => {
                    // Service filter
                    if (this.selectedServices.size > 0 && !this.selectedServices.has(log.service)) {
                        return false;
                    }

                    // Level filter
                    if (levelFilter && log.level !== levelFilter) {
                        return false;
                    }

                    // Search filter
                    if (searchTerm) {
                        const searchableText = `${log.message} ${log.service} ${log.logger}`.toLowerCase();
                        if (!searchableText.includes(searchTerm)) {
                            return false;
                        }
                    }

                    return true;
                });

                this.renderLogs();
                this.updateStats();
            }

            renderLogs() {
                const logViewer = document.getElementById('logViewer');
                const showTrace = document.getElementById('showTrace').checked;

                if (this.filteredLogs.length === 0) {
                    logViewer.innerHTML = '<div class="loading">No logs to display</div>';
                    return;
                }

                const logsToShow = this.filteredLogs.slice(-1000); // Show last 1000 for performance

                logViewer.innerHTML = logsToShow.map((log, index) => {
                    const actualIndex = this.filteredLogs.length - 1000 + index;
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    const traceInfo = showTrace && log.trace_id ? ` [${log.trace_id}]` : '';

                    return `
                        <div class="log-entry ${this.selectedLog === actualIndex ? 'selected' : ''}"
                             data-index="${actualIndex}">
                            <div class="log-timestamp">${timestamp}</div>
                            <div class="log-level ${log.level}">${log.level}</div>
                            <div class="log-service">${log.service}${traceInfo}</div>
                            <div class="log-message">${this.escapeHtml(log.message)}</div>
                        </div>
                    `;
                }).join('');

                if (this.autoScroll) {
                    logViewer.scrollTop = logViewer.scrollHeight;
                }
            }

            selectLog(index) {
                this.selectedLog = index;
                const log = this.filteredLogs[index];

                if (log) {
                    document.getElementById('rawLogJson').textContent = JSON.stringify(log, null, 2);
                    this.renderLogs();
                }
            }

            updateServicesFilter() {
                const servicesList = document.getElementById('servicesList');

                if (this.services.size === 0) {
                    servicesList.innerHTML = '<div class="loading">No services detected</div>';
                    return;
                }

                servicesList.innerHTML = Array.from(this.services).sort().map(service => `
                    <div class="service-item ${this.selectedServices.has(service) ? 'active' : ''}"
                         data-service="${service}">
                        <input type="checkbox" class="service-checkbox"
                               ${this.selectedServices.has(service) ? 'checked' : ''}>
                        <span>${service}</span>
                    </div>
                `).join('');

                // Add click handlers
                servicesList.querySelectorAll('.service-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const service = item.dataset.service;
                        const checkbox = item.querySelector('.service-checkbox');

                        if (this.selectedServices.has(service)) {
                            this.selectedServices.delete(service);
                            checkbox.checked = false;
                            item.classList.remove('active');
                        } else {
                            this.selectedServices.add(service);
                            checkbox.checked = true;
                            item.classList.add('active');
                        }

                        this.filterLogs();
                    });
                });
            }

            updateStats() {
                document.getElementById('totalLogs').textContent = this.logs.length;
                document.getElementById('filteredLogs').textContent = this.filteredLogs.length;
            }

            updateStatus(connected, text) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                statusDot.className = `status-dot ${connected ? 'connected' : ''}`;
                statusText.textContent = text;
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                const pauseBtn = document.getElementById('pauseBtn');
                pauseBtn.textContent = this.isPaused ? 'Resume' : 'Pause';
                pauseBtn.classList.toggle('active', this.isPaused);
            }

            toggleDetails() {
                const details = document.getElementById('logDetails');
                const toggle = document.getElementById('detailsToggle');

                details.classList.toggle('visible');
                toggle.textContent = details.classList.contains('visible') ? 'Hide Details' : 'Show Details';
            }

            clearLogs() {
                this.logs = [];
                this.filteredLogs = [];
                this.selectedLog = null;
                this.renderLogs();
                this.updateStats();
                document.getElementById('rawLogJson').textContent = 'Select a log entry to view details';
            }

            exportLogs() {
                const dataStr = JSON.stringify(this.filteredLogs, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `mohnitor-logs-${new Date().toISOString().slice(0, 19)}.json`;
                link.click();

                URL.revokeObjectURL(url);
            }

            clearLoadingMessage() {
                const logViewer = document.getElementById('logViewer');
                if (logViewer.innerHTML.includes('Connecting to Mohnitor hub')) {
                    logViewer.innerHTML = '<div class="loading">Waiting for log events...</div>';
                }
            }

            showError(message) {
                const existing = document.querySelector('.error-message');
                if (existing) existing.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.querySelector('.main-content').prepend(errorDiv);

                setTimeout(() => errorDiv.remove(), 5000);
            }

            showFallbackMessage() {
                const logViewer = document.getElementById('logViewer');
                logViewer.innerHTML = `
                    <div class="loading">
                        <div style="text-align: center; padding: 40px;">
                            <h3>ðŸ”Œ WebSocket Connection Failed</h3>
                            <p style="margin: 16px 0; color: #888;">
                                Unable to connect to Mohnitor hub. This could be because:
                            </p>
                            <ul style="text-align: left; color: #888; max-width: 400px; margin: 0 auto;">
                                <li>Hub server is not running</li>
                                <li>WebSocket dependencies not installed</li>
                                <li>Browser doesn't support WebSockets</li>
                            </ul>
                            <p style="margin: 16px 0; color: #4CAF50;">
                                Install Mohnitor dependencies: <code>pip install mohflow[mohnitor]</code>
                            </p>
                            <button onclick="location.reload()" style="margin-top: 16px;">
                                Retry Connection
                            </button>
                        </div>
                    </div>
                `;
            }

            startLogRateCalculation() {
                this.rateInterval = setInterval(() => {
                    const currentCount = this.logs.length;
                    this.logRate = Math.max(0, currentCount - this.lastLogCount);
                    this.lastLogCount = currentCount;
                    document.getElementById('logRate').textContent = this.logRate;
                }, 1000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the UI when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MohnitorUI();
        });
    </script>
</body>
</html>